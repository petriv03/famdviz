#' Plot variables
#'
#' Calculate the square root of a numeric value
#' @param x the numeric value
#' @return the square root of x
#' @examples
#' sqroot(22);
#' @export
plot_variables <- function(famd, dim_x, dim_y, color_by) {
  variables <- get_variables(famd, dim_x, dim_y, color_by)
  mean_color <- mean(variables[, 3])
  figure <- ggplot(variables, aes(x = data_frame[, 1],
                                  y = data_frame[, 2],
                                  color = data_frame[, 3],
                                  label = rownames(variables))) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    geom_vline(xintercept = 0, linetype = "dashed") +
    geom_point(shape = 17) +
    geom_text_repel(max.overlaps = Inf, size=3) +
    labs(x = NULL, y = NULL) +
    set_gradient(mean_color) +
    set_custom_theme(legend_position_x = 1,
                     legend_position_y = 1,
                     axis_text_x = T,
                     axis_text_y = T) +
    guides(color = guide_colourbar(title = toupper(color_by)))
  return(figure)
}

#' Get Variables
#'
#' Get variables of factoMineR::FAMD model as an input for plot_variables function
#' @param famd list produced by factoMineR::FAMD function
#' @param dim_x first dimension integer
#' @param dim_y second dimension integer
#' @param color_by "contrib" or "cos2" (see factoMineR::FAMD documentation)
#' @return a data frame of x, y coordinates and color intensities
#' @examples
#' famd <- factoMineR::FAMD(x, graph = F)
#' vars <- get_variables(famd, 1, 2, "cos2")
#' print(vars)
#' @export
get_variables <- function(famd, dim_x, dim_y, color_by) {
  coordinates <- rbind(as.data.frame(model$quali.var[["coord"]]),
                       as.data.frame(model$quanti.var[["coord"]])
                       )
  coordinates <- coordinates[, c(dim_x, dim_y)]
  colors <- rbind(as.data.frame(model$quali.var[[color_by]]),
                  as.data.frame(model$quanti.var[[color_by]])
                  )
  colors <- data.frame(colors[, 1] + colors[, 2])
  colnames(colors) <- c(color_by)
  variables <- cbind(coordinates, colors)
  return(variables)
}

#' Set Gradient
#'
#' Supporting function for ggplot generates 3-point scale_colour_gradient2
#' @param midpoint the numeric value indicating mid color
#' @return scale_colour_gradient2()
#' @examples
#' data_frame <- data.frame(x = c(1, 2, 3),
#'                          y = c(1, 2, 3),
#'                          z = c(12.8, 6.5, 15.4))
#' mean_color <- mean(data_frame[, "z"])
#' ggplot(data_frame, aes(x = x, y = y, color = z) +
#'   geom_point(shape = 17) +
#'   set_gradient(mean_color)
#' @export
set_gradient <- function(midpoint) {
  scale_colour_gradient2(low="#00AFBB",
                         mid="#E7B800",
                         high="#FC4E07",
                         midpoint = mean(midpoint))
}



set_custom_theme <- function(legend_position_x,
                             legend_position_y,
                             axis_text_x = T,
                             axis_text_y = T) {

  if(axis_text_x){x_text <- element_text()} else {x_text <- element_blank()}
  if(axis_text_y){y_text <- element_text()} else {y_text <- element_blank()}

  theme_bw() +
    theme(
      axis.text.x = x_text,
      axis.text.y = y_text,
      text = element_text(size = 8),
      legend.background = element_rect(fill = "transparent"),
      legend.key=element_rect(fill = "transparent"),
      legend.justification = c(legend_position_x, legend_position_y),
      legend.position = c(legend_position_x, legend_position_y),
      legend.title = element_text(face="bold")
    )
}
